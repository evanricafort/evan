<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Security Analyzer</title>
    <link href="profile.jpg" type="image/gif" rel="shortcut icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sun-icon, .moon-icon {
            transition: opacity 0.3s;
        }
        [data-theme="light"] .moon-icon { opacity: 0; }
        [data-theme="dark"] .sun-icon { opacity: 0; }
        
        .toggle-button svg {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-button svg.rotate-90 {
            transform: rotate(90deg);
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-indigo': '#4f46e5',
                        'primary-dark': '#1e293b',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans min-h-screen p-4 sm:p-8">

<div class="max-w-7xl mx-auto">
    <header class="text-center mb-10 relative">
        <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-50 mb-2">
            <span class="text-primary-indigo dark:text-indigo-400">SSH</span> Security Analyzer
        </h1>
        <p class="text-lg text-gray-500 dark:text-gray-400">
            Analyze SSH configurations or Nmap SSH scan result for cryptographic risks.
        </p>

        <button id="darkModeToggle" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition" onclick="toggleDarkMode()">
            <svg class="sun-icon w-6 h-6 text-yellow-500" data-theme="light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.5-4.5l-1.591 1.591M3 12h2.25m.386-6.364l1.591 1.591M12 2.25a9.75 9.75 0 100 19.5 9.75 9.75 0 000-19.5z" />
            </svg>
            <svg class="moon-icon w-6 h-6 text-indigo-400 absolute top-2 right-2" data-theme="dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a1.5 1.5 0 01-1.5 1.5h-15a1.5 1.5 0 01-1.5-1.5V6.75m19.5 0A.75.75 0 0021 6H3a.75.75 0 00-.75.75m19.5 0v.243a2.75 2.75 0 01-5.698 0l-.821 5.378a2.75 2.75 0 01-5.32 0l-.82-5.378A2.75 2.75 0 013.75 6.993V6.75M10.375 13.5l1.625-2.25 1.625 2.25M12 10.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 01.75-.75z" />
            </svg>
        </button>
    </header>

    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl p-6 sm:p-8 mb-8 ring-1 ring-gray-100 dark:ring-gray-700 transition-colors duration-300">
        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 border-gray-100 dark:border-gray-700">Input Data</h3>
        <textarea id="configInput" 
                  class="w-full h-40 p-4 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-700 dark:text-gray-100 font-mono text-sm resize-y transition-colors duration-300" 
                  placeholder="Paste Nmap SSH scan output or sshd_config here..."></textarea>
        <div class="flex justify-end mt-4">
            <button class="px-6 py-2 font-semibold text-white bg-primary-indigo rounded-lg shadow-lg hover:bg-indigo-700 transition duration-200 ease-in-out transform hover:scale-[1.02]" 
                    onclick="analyzeInput()">
                Analyze Data
            </button>
        </div>
    </div>

    <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
        <button id="tab-report-btn" onclick="setActiveTab('report')" class="tab-btn px-4 py-3 text-lg font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-primary-indigo hover:border-primary-indigo dark:hover:text-indigo-400 dark:hover:border-indigo-400 transition-colors duration-200">
            Analysis Report
        </button>
        <button id="tab-database-btn" onclick="setActiveTab('database')" class="tab-btn px-4 py-3 text-lg font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-primary-indigo hover:border-primary-indigo dark:hover:text-indigo-400 dark:hover:border-indigo-400 transition-colors duration-200">
            Algorithm Database
        </button>
    </div>

    <div id="tab-report" class="tab-content">
        <div id="resultsPanel" class="bg-white dark:bg-gray-800 shadow-xl rounded-xl p-6 sm:p-8 mb-8 ring-1 ring-gray-100 dark:ring-gray-700 transition-colors duration-300" style="display:none;">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-4 mb-4 sm:mb-0">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Vulnerability Findings</h2>
                    <span id="securityScore" class="px-4 py-1.5 text-sm font-extrabold rounded-full shadow-lg transition duration-200">Checking...</span>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <button id="copyHostsButton" 
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out" 
                            onclick="copyHostsOnly()">
                        Copy Hosts/IPs
                    </button>
                    <button id="copyConciseButton" 
                            class="px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-lg shadow-md hover:bg-gray-800 transition duration-150 ease-in-out" 
                            onclick="copyConciseResults()">
                        Copy Concise List
                    </button>
                    <button id="copyButton" 
                            class="px-4 py-2 text-sm font-medium text-white bg-cyan-600 rounded-lg shadow-md hover:bg-cyan-700 transition duration-150 ease-in-out" 
                            onclick="copyDetailedResults()">
                        Copy Detailed Results
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto rounded-lg shadow-md ring-1 ring-gray-200 dark:ring-gray-700">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700" id="resultsTable">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer text-gray-500 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition" onclick="sortTable(0)">
                                Host / IP <span class="text-primary-indigo">&#x2195;</span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer text-gray-500 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition" onclick="sortTable(1)">
                                Overall Status <span class="text-primary-indigo">&#x2195;</span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">
                                Details
                            </th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-database" class="tab-content" style="display:none;">
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-xl p-6 sm:p-8 mb-8 ring-1 ring-gray-100 dark:ring-gray-700 transition-colors duration-300">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 border-b pb-2 border-gray-100 dark:border-gray-700">Known Algorithm Definitions</h2>
            <div class="mb-4">
                <input type="text" id="databaseSearch" onkeyup="filterDatabase()" placeholder="Search by name, status, or description..."
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo dark:bg-gray-700 dark:text-gray-100 transition-colors duration-300">
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md ring-1 ring-gray-200 dark:ring-gray-700">
                   <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700" id="databaseTable">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Algorithm Name</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Reason / Description</th>
                        </tr>
                    </thead>
                    <tbody id="databaseBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    </tbody>
                   </table>
            </div>
        </div>
    </div>

</div>

<div id="copyMessage" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50">Copied to clipboard!</div>

<script>
    const apiKey = ""; 
    let currentFindings = []; 
    let activeTab = 'report';

    const DATABASE = {
        ciphers: {
            'arcfour': { status: 'CRITICAL', reason: 'RC4 is broken.' },
            'arcfour128': { status: 'CRITICAL', reason: 'RC4 is broken.' },
            'arcfour256': { status: 'CRITICAL', reason: 'RC4 is broken.' },
            '3des-cbc': { status: 'WEAK', reason: 'Sweet32 vulnerability (64-bit block).' },
            'blowfish-cbc': { status: 'WEAK', reason: 'Sweet32 vulnerability (64-bit block).' },
            'cast128-cbc': { status: 'WEAK', reason: 'Sweet32 vulnerability (64-bit block).' },
            'aes128-cbc': { status: 'LEGACY', reason: 'CBC mode is malleable. Prefer CTR/GCM.' },
            'aes192-cbc': { status: 'LEGACY', reason: 'CBC mode is malleable. Prefer CTR/GCM.' },
            'aes256-cbc': { status: 'LEGACY', reason: 'CBC mode is malleable. Prefer CTR/GCM.' },
            'rijndael-cbc@lysator.liu.se': { status: 'LEGACY', reason: 'CBC mode is malleable.' },
            'aes128-ctr': { status: 'SECURE', reason: 'Standard secure symmetric cipher.' },
            'aes192-ctr': { status: 'SECURE', reason: 'Standard secure symmetric cipher.' },
            'aes256-ctr': { status: 'SECURE', reason: 'Standard secure symmetric cipher.' },
            'aes128-gcm@openssh.com': { status: 'SECURE', reason: 'Modern AEAD cipher.' },
            'aes256-gcm@openssh.com': { status: 'SECURE', reason: 'Modern AEAD cipher.' },
            'chacha20-poly1305@openssh.com': { status: 'SECURE', reason: 'Modern AEAD cipher, fast & secure.' }
        },
        macs: {
            'hmac-md5': { status: 'CRITICAL', reason: 'MD5 is collision-vulnerable.' },
            'hmac-md5-96': { status: 'CRITICAL', reason: 'MD5 obsolete + truncation too short.' },
            'hmac-sha1-96': { status: 'WEAK', reason: '96-bit truncation too short.' },
            'hmac-sha1': { status: 'LEGACY', reason: 'SHA1 deprecated. Use SHA-2.' },
            'hmac-sha1-etm@openssh.com': { status: 'LEGACY', reason: 'SHA1 deprecated (EtM mitigation).' },
            'hmac-sha2-256': { status: 'SECURE', reason: 'Standard secure MAC.' },
            'hmac-sha2-512': { status: 'SECURE', reason: 'Standard secure MAC.' },
            'hmac-sha2-256-etm@openssh.com': { status: 'SECURE', reason: 'Secure Encrypt-then-MAC.' },
            'hmac-sha2-512-etm@openssh.com': { status: 'SECURE', reason: 'Secure Encrypt-then-MAC.' },
            'umac-128@openssh.com': { status: 'SECURE', reason: 'Optimized secure MAC.' }
        },
        kex: {
            'diffie-hellman-group1-sha1': { status: 'CRITICAL', reason: 'Logjam (1024-bit) & SHA1.' },
            'diffie-hellman-group14-sha1': { status: 'WEAK', reason: 'SHA1 deprecated. Prefer SHA2.' },
            'diffie-hellman-group-exchange-sha1': { status: 'WEAK', reason: 'SHA1 deprecated.' },
            'curve25519-sha256': { status: 'SECURE', reason: 'Modern ECDH.' },
            'curve25519-sha256@libssh.org': { status: 'SECURE', reason: 'Modern ECDH.' },
            'diffie-hellman-group14-sha256': { status: 'SECURE', reason: 'Secure FFDH with SHA2.' },
            'diffie-hellman-group16-sha512': { status: 'SECURE', reason: 'Secure FFDH with SHA2.' },
            'diffie-hellman-group18-sha512': { status: 'SECURE', reason: 'Secure FFDH with SHA2.' },
            'diffie-hellman-group-exchange-sha256': { status: 'SECURE', reason: 'Secure (if modulus > 2048).' },
            'ecdh-sha2-nistp256': { status: 'SECURE', reason: 'NIST curve.' },
            'ecdh-sha2-nistp384': { status: 'SECURE', reason: 'NIST curve.' },
            'ecdh-sha2-nistp521': { status: 'SECURE', reason: 'NIST curve.' }
        },
        keys: {
            'ssh-dss': { status: 'CRITICAL', reason: 'DSA is insecure (disabled in OpenSSH).' },
            'ssh-rsa': { status: 'WEAK', reason: 'RSA w/ SHA1 signatures deprecated.' },
            'rsa-sha2-256': { status: 'SECURE', reason: 'Secure RSA signature.' },
            'rsa-sha2-512': { status: 'SECURE', reason: 'Secure RSA signature.' },
            'ssh-ed25519': { status: 'SECURE', reason: 'Modern EdDSA key.' },
            'ecdsa-sha2-nistp256': { status: 'SECURE', reason: 'NIST curve key.' }
        }
    };

    function getStatusClasses(status) {
        switch (status) {
            case 'CRITICAL': return 'bg-red-600 text-white shadow-red-900/50';
            case 'WEAK': return 'bg-amber-400 text-amber-900 shadow-amber-900/50';
            case 'LEGACY': return 'bg-yellow-300 text-yellow-900 shadow-yellow-900/50';
            case 'SECURE': return 'bg-green-600 text-white shadow-green-900/50';
            default: return 'bg-gray-400 text-gray-800';
        }
    }

    function showCopyMessage(message) {
        const messageEl = document.getElementById('copyMessage');
        messageEl.textContent = message;
        messageEl.classList.remove('opacity-0');
        messageEl.classList.add('opacity-100');
        setTimeout(() => {
            messageEl.classList.remove('opacity-100');
            messageEl.classList.add('opacity-0');
        }, 3000);
    }
    
    function copyToClipboard(text) {
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = text;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy'); 
        document.body.removeChild(tempTextArea);
        showCopyMessage("Results copied to clipboard!");
    }
    
    function copyHostsOnly() {
        if (currentFindings.length === 0) {
            showCopyMessage("No hosts or IPs detected to copy.");
            return;
        }

        const uniqueHosts = [...new Set(currentFindings.map(f => f.host))];
        
        let textToCopy = "Detected SSH Hosts/IPs:\n\n" + uniqueHosts.join('\n');
        
        copyToClipboard(textToCopy);
    }


    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateDarkModeIcon(isDark ? 'dark' : 'light');
    }

    function updateDarkModeIcon(theme) {
        const button = document.getElementById('darkModeToggle');
        if (button) {
            button.setAttribute('data-theme', theme);
        }
    }

    function initializeDarkMode() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        let themeToSet = 'light';
        if (savedTheme) {
            themeToSet = savedTheme;
        } else if (systemPrefersDark) {
            themeToSet = 'dark';
        }

        if (themeToSet === 'dark') {
            document.documentElement.classList.add('dark');
        }
        updateDarkModeIcon(themeToSet);
        renderDatabase();
    }

    function setActiveTab(tabId) {
        activeTab = tabId;
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('border-primary-indigo', 'text-primary-indigo', 'dark:border-indigo-400', 'dark:text-indigo-400', 'border-opacity-100');
            el.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        });

        document.getElementById(`tab-${tabId}`).style.display = 'block';
        const activeBtn = document.getElementById(`tab-${tabId}-btn`);
        activeBtn.classList.add('border-primary-indigo', 'text-primary-indigo', 'dark:border-indigo-400', 'dark:text-indigo-400', 'border-opacity-100');
        activeBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    }

    function renderDatabase() {
        const databaseBody = document.getElementById('databaseBody');
        databaseBody.innerHTML = '';
        let allAlgos = [];

        Object.keys(DATABASE).forEach(typeKey => {
            Object.keys(DATABASE[typeKey]).forEach(name => {
                const typeLabel = typeKey.charAt(0).toUpperCase() + typeKey.slice(1);
                allAlgos.push({
                    type: typeLabel,
                    name: name,
                    status: DATABASE[typeKey][name].status,
                    reason: DATABASE[typeKey][name].reason
                });
            });
        });

        allAlgos.forEach(algo => {
            const row = databaseBody.insertRow();
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150';
            const statusClass = getStatusClasses(algo.status);

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600 dark:text-indigo-300">${algo.type.toUpperCase()}</td>
                <td class="px-6 py-4 text-sm font-mono text-pink-600 dark:text-pink-400">${algo.name}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 text-xs font-extrabold rounded-full ${statusClass}">${algo.status}</span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">${algo.reason}</td>
            `;
        });
    }

    function filterDatabase() {
        const input = document.getElementById('databaseSearch').value.toLowerCase();
        const table = document.getElementById('databaseTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            let row = rows[i];
            let cells = row.getElementsByTagName('td');
            let found = false;
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().includes(input)) {
                    found = true;
                    break;
                }
            }
            row.style.display = found ? '' : 'none';
        }
    }


    function toggleDetails(button) {
        const row = button.closest('tr');
        const nextRow = row.nextElementSibling;
        
        if (nextRow && nextRow.classList.contains('details-row')) {
            nextRow.classList.toggle('hidden');
            
            const icon = button.querySelector('svg');
            icon.classList.toggle('rotate-90');
        }
    }


    function getProblematicGroups() {
        const problematicFindings = currentFindings.filter(f => 
            f.status === 'CRITICAL' || f.status === 'WEAK' || f.status === 'LEGACY'
        );

        const groupedResults = {};
        problematicFindings.forEach(f => {
            const host = f.host;
            const status = f.status;

            if (!groupedResults[host]) {
                groupedResults[host] = {
                    worstStatus: status,
                    findings: []
                };
            } else {
                const currentWorst = groupedResults[host].worstStatus;
                if (status === 'CRITICAL') {
                    groupedResults[host].worstStatus = 'CRITICAL';
                } else if (status === 'WEAK' && currentWorst === 'LEGACY') {
                    groupedResults[host].worstStatus = 'WEAK';
                }
            }
            groupedResults[host].findings.push(f);
        });
        return groupedResults;
    }

    function deduplicateFindings(findings) {
        const seen = new Set();
        const uniqueFindings = [];
        
        findings.forEach(f => {
            const key = `${f.host}|${f.type}|${f.name}`;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueFindings.push(f);
            }
        });
        return uniqueFindings;
    }


    function analyzeInput() {
        const input = document.getElementById('configInput').value;
        const resultsPanel = document.getElementById('resultsPanel');
        const resultsBody = document.getElementById('resultsBody');
        const scoreBadge = document.getElementById('securityScore');
        
        setActiveTab('report');
        resultsPanel.style.display = 'block';
        resultsBody.innerHTML = '';
        scoreBadge.className = 'px-4 py-1.5 text-sm font-extrabold rounded-full shadow-lg transition duration-200'; 

        if (!input.trim()) {
            resultsBody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-500 dark:text-gray-400">Please enter data to analyze.</td></tr>';
            scoreBadge.style.display = 'none';
            return;
        }

        let findings = [];
        
        const isNmap = /\|\s+(kex_|encryption_|mac_|server_host_key_)/i.test(input) || /ssh2-enum-algos/i.test(input);
        
        if (isNmap) {
            findings = parseNmap(input);
        } else {
            findings = parseConfig(input);
        }

        findings = deduplicateFindings(findings);

        currentFindings = findings.filter(f => f.status !== 'UNKNOWN');
        const problematicFindings = currentFindings.filter(f => f.status !== 'SECURE');

        if (currentFindings.length === 0) {
             resultsBody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-500 dark:text-gray-400">No valid cryptographic primitives found in input.</td></tr>';
             scoreBadge.style.display = 'none';
             return;
        }

        if (problematicFindings.length === 0 && currentFindings.length > 0) {
            resultsBody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-green-600 dark:text-green-400 font-bold">No weak ciphers detected!<br><span class="font-normal text-sm text-gray-500 dark:text-gray-400">All ' + currentFindings.length + ' detected algorithms are marked as SECURE.</span></td></tr>';
        }

        const groupedFindings = {};
        problematicFindings.forEach(f => {
            if (!groupedFindings[f.host]) {
                groupedFindings[f.host] = [];
            }
            groupedFindings[f.host].push(f);
        });

        let counts = { CRITICAL: 0, WEAK: 0, LEGACY: 0, SECURE: 0, UNKNOWN: 0 };
        currentFindings.forEach(f => counts[f.status]++);

        Object.keys(groupedFindings).forEach((host, index) => {
            const items = groupedFindings[host];
            
            let hostStatus = 'LEGACY';
            if (items.some(i => i.status === 'CRITICAL')) hostStatus = 'CRITICAL';
            else if (items.some(i => i.status === 'WEAK')) hostStatus = 'WEAK';

            let hostStatusClass = getStatusClasses(hostStatus);

            const mainRow = document.createElement('tr');
            mainRow.className = 'hover:bg-indigo-50/50 dark:hover:bg-gray-700/50 transition-colors duration-150 cursor-pointer'; 
            mainRow.onclick = (e) => { 
                if (!e.target.closest('.status-badge')) {
                     const toggleButton = mainRow.querySelector('.toggle-button');
                     if (toggleButton) toggleDetails(toggleButton);
                }
            };
            
            mainRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${host}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="px-3 py-1 text-xs font-extrabold rounded-full ${hostStatusClass} status-badge">${hostStatus}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="toggle-button text-gray-400 hover:text-primary-indigo dark:hover:text-indigo-400 transition transform duration-200" title="Toggle details" onclick="event.stopPropagation(); toggleDetails(this);">
                        <svg class="w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </button>
                </td>
            `;
            resultsBody.appendChild(mainRow);
            
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row hidden bg-gray-50 dark:bg-gray-800/80';
            detailsRow.innerHTML = `
                <td colspan="3" class="p-0 border-t border-gray-200 dark:border-gray-700">
                    <div class="p-4 sm:p-6">
                        <h4 class="text-md font-semibold mb-3 text-gray-700 dark:text-gray-300">Vulnerable Algorithms Detected:</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-100 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Type</th>
                                        <th class="py-2 px-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Algorithm</th>
                                        <th class="py-2 px-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Status</th>
                                        <th class="py-2 px-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-300">Reason / Fix</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map(f => {
                                        let itemStatusClass = getStatusClasses(f.status);
                                        return `
                                            <tr class="border-b border-gray-100 dark:border-gray-700/50 last:border-b-0">
                                                <td class="py-2 px-4 text-sm text-indigo-600 dark:text-indigo-300">${f.type}</td>
                                                <td class="py-2 px-4 text-sm font-mono text-pink-600 dark:text-pink-400">${f.name}</td>
                                                <td class="py-2 px-4 whitespace-nowrap">
                                                    <span class="px-2 py-0.5 text-xs font-medium rounded-full ${itemStatusClass}">${f.status}</span>
                                                </td>
                                                <td class="py-2 px-4 text-sm text-gray-700 dark:text-gray-300">${f.reason}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </td>
            `;
            resultsBody.appendChild(detailsRow);
        });
        
        const overallStatus = counts.CRITICAL > 0 ? 'CRITICAL' : (counts.WEAK > 0 ? 'WEAK' : (counts.LEGACY > 0 ? 'LEGACY' : 'SECURE'));
        const scoreClass = getStatusClasses(overallStatus);
        
        scoreBadge.textContent = overallStatus;
        scoreBadge.className = `px-4 py-1.5 text-sm font-extrabold rounded-full shadow-lg transition duration-200 ${scoreClass}`;
        scoreBadge.style.display = 'inline-block';
    }


    /**
     * Parses Nmap output for SSH algorithm enumeration.
     * @param {string} input - The Nmap output text.
     * @returns {Array<Object>} An array of findings.
     */
    function parseNmap(input) {
        const findings = [];
        const lines = input.split('\n');
        
        let currentHost = 'Nmap Scan Result';

        // Regex to find the host/IP line
        const hostMatch = input.match(/Nmap scan report for ([\w.-]+) \(([\d.]+)\)/i);
        if (hostMatch) {
            currentHost = hostMatch[1] || hostMatch[2];
        } else {
            const alternateHostMatch = input.match(/Host: ([\w.-]+)/i);
            if (alternateHostMatch) {
                currentHost = alternateHostMatch[1];
            }
        }

        const typeMap = {
            'kex_': 'KEX',
            'encryption_': 'Cipher',
            'mac_': 'MAC',
            'server_host_key_': 'Key'
        };

        const regex = /\|\s+(kex_|encryption_|mac_|server_host_key_)(\w+)\s*:\s*(.*?)$/gmi;
        let match;

        while ((match = regex.exec(input)) !== null) {
            const prefix = match[1].toLowerCase();
            const typeKey = prefix.slice(0, -1); 
            const algos = match[3].split(',').map(a => a.trim()).filter(a => a.length > 0);

            algos.forEach(algo => {
                const dbEntry = DATABASE[typeKey][algo.toLowerCase()];
                const status = dbEntry ? dbEntry.status : 'UNKNOWN';
                const reason = dbEntry ? dbEntry.reason : 'Algorithm not found in database or is non-standard.';
                
                findings.push({
                    host: currentHost,
                    type: typeMap[prefix],
                    name: algo,
                    status: status,
                    reason: reason
                });
            });
        }
        
        return findings;
    }

    /**
     * Parses sshd_config style input.
     * @param {string} input - The sshd_config style text.
     * @returns {Array<Object>} An array of findings (only one host).
     */
    function parseConfig(input) {
        const findings = [];
        const lines = input.split('\n');
        const host = 'sshd_config'; 

        const configMap = {
            'Ciphers': 'ciphers',
            'MACs': 'macs',
            'KexAlgorithms': 'kex',
            'HostKeyAlgorithms': 'keys'
        };

        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('#')) return; 

            const parts = trimmedLine.match(/^(\w+)\s+(.*)/);
            if (!parts) return;

            const directive = parts[1];
            const value = parts[2];
            const dbKey = configMap[directive];

            if (dbKey) {
                const algos = value.split(',').map(a => a.trim()).filter(a => a.length > 0);
                const typeLabel = directive.replace('Algorithms', '');
                
                algos.forEach(algo => {
                    const dbEntry = DATABASE[dbKey][algo.toLowerCase()];
                    const status = dbEntry ? dbEntry.status : 'UNKNOWN';
                    const reason = dbEntry ? dbEntry.reason : 'Algorithm not found in database or is non-standard.';
                    
                    findings.push({
                        host: host,
                        type: typeLabel,
                        name: algo,
                        status: status,
                        reason: reason
                    });
                });
            }
        });

        return findings;
    }


    /**
     * Copy functions (Concise and Detailed)
     */
    function copyConciseResults() {
        if (currentFindings.length === 0) {
            showCopyMessage("No findings to copy.");
            return;
        }

        const problematicGroups = getProblematicGroups();
        let textToCopy = "SSH Security Analyzer - Concise Report\n\n";

        if (Object.keys(problematicGroups).length === 0) {
            textToCopy += "All detected algorithms are marked as SECURE.\n";
        } else {
            Object.keys(problematicGroups).forEach(host => {
                const hostData = problematicGroups[host];
                textToCopy += `Host: ${host} (Status: ${hostData.worstStatus})\n`;
                hostData.findings.forEach(f => {
                    textToCopy += `- [${f.status}] ${f.type}: ${f.name} (${f.reason})\n`;
                });
                textToCopy += '\n';
            });
        }
        copyToClipboard(textToCopy);
    }

    function copyDetailedResults() {
        if (currentFindings.length === 0) {
            showCopyMessage("No findings to copy.");
            return;
        }

        const problematicGroups = getProblematicGroups();
        let textToCopy = "SSH Security Analyzer - Detailed Report\n\n";

        if (Object.keys(problematicGroups).length === 0) {
            textToCopy += "All detected algorithms are marked as SECURE.\n";
        } else {
            Object.keys(problematicGroups).forEach(host => {
                const hostData = problematicGroups[host];
                textToCopy += `======================================================\n`;
                textToCopy += `HOST: ${host} (Overall: ${hostData.worstStatus})\n`;
                textToCopy += `======================================================\n`;
                textToCopy += `Status | Type | Algorithm | Reason\n`;
                textToCopy += `------------------------------------------------------\n`;
                hostData.findings.forEach(f => {
                    textToCopy += `${f.status.padEnd(6)} | ${f.type.padEnd(4)} | ${f.name.padEnd(25)} | ${f.reason}\n`;
                });
                textToCopy += '\n';
            });
        }
        copyToClipboard(textToCopy);
    }
    
    /**
     * Table Sorting Logic
     */
    let sortDirection = {}; 
    
    function sortTable(n) {
        const table = document.getElementById("resultsTable");
        const tbody = document.getElementById("resultsBody");
        const rows = Array.from(tbody.rows);
        const columnKeys = ['host', 'worstStatus', 'details']; 
        const key = columnKeys[n];

        // Toggle sort direction
        const currentDirection = sortDirection[key] === 'asc' ? 'desc' : 'asc';
        sortDirection[key] = currentDirection;

        // Comparator logic
        rows.sort((rowA, rowB) => {
            let a = rowA.cells[n].textContent.trim();
            let b = rowB.cells[n].textContent.trim();

            if (key === 'worstStatus') {
                const statusOrder = { 'CRITICAL': 4, 'WEAK': 3, 'LEGACY': 2, 'SECURE': 1, 'UNKNOWN': 0 };
                a = statusOrder[a] || 0;
                b = statusOrder[b] || 0;
            } else if (key === 'host') {
                // Natural sort for strings/IPs
                return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            }

            let comparison = 0;
            if (a > b) {
                comparison = 1;
            } else if (a < b) {
                comparison = -1;
            }
            
            return currentDirection === 'asc' ? comparison : comparison * -1;
        });
        
        // Rebuild tbody, ensuring details rows stay attached
        const newTbody = document.createElement('tbody');
        newTbody.id = "resultsBody";
        newTbody.className = "bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700";

        rows.forEach(row => {
            newTbody.appendChild(row);
            const nextRow = row.nextElementSibling;
            if (nextRow && nextRow.classList.contains('details-row')) {
                newTbody.appendChild(nextRow);
            }
        });

        tbody.parentNode.replaceChild(newTbody, tbody);
    }


    window.onload = initializeDarkMode;
    window.toggleDarkMode = toggleDarkMode;
    window.analyzeInput = analyzeInput;
    window.setActiveTab = setActiveTab;
    window.filterDatabase = filterDatabase;
    window.toggleDetails = toggleDetails;
    window.copyHostsOnly = copyHostsOnly;
    window.copyConciseResults = copyConciseResults;
    window.copyDetailedResults = copyDetailedResults;
    window.sortTable = sortTable;

</script>
</body>
</html>
